on:
  push:
    branches:
      - "release/*"
name: release-please

permissions:
  contents: write # Required for creating releases
  pull-requests: write # Required for release-please to create/update PRs
jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Create app token
        id: app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write # to create release commits and tags
          permission-pull-requests: write # to create release PRs

      - name: Extract branch name
        shell: bash
        run: echo "branch=$(echo "${GITHUB_REF#refs/heads/}")" >> $GITHUB_OUTPUT
        id: extract_branch
      - uses: google-github-actions/release-please-action@db8f2c60ee802b3748b512940dde88eabd7b7e01 # v3.7.13
        id: release
        with:
          token: ${{ steps.app-token.outputs.token }}
          pull-request-title-pattern: "chore: release ${version}"
          release-type: go
          package-name: rudder-server
          default-branch: ${{ steps.extract_branch.outputs.branch }}
          changelog-types: '[{"type":"feat","section":"Features","hidden":false},{"type":"fix","section":"Bug Fixes","hidden":false},{"type":"chore","section":"Miscellaneous","hidden":false},{"type":"refactor","section":"Miscellaneous","hidden":false},{"type":"test","section":"Miscellaneous","hidden":false},{"type":"doc","section":"Documentation","hidden":false}]'
          bump-minor-pre-major: true
      - name: Extract release version
        shell: bash
        run: |
          tag_name=$(echo "${{ steps.release.outputs.tag_name }}")
          version=$(echo "${tag_name#v}")
          echo "version=${version}" >> $GITHUB_OUTPUT
        id: extract_version
      - name: Create app token for cross-repo dispatch
        id: app-dispatch-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write
          repositories: rudderstack-operator,rudder-devops
      - name: Trigger dispatch event - Enterprise
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
        # release please run 2 times, first for creating the PR and second for creating the release
        if: ${{ steps.release.outputs.releases_created == 'true' }}
        with:
          token: ${{ steps.app-dispatch-token.outputs.token }}
          repository: rudderlabs/rudderstack-operator
          event-type: release-rudder-server
          client-payload: |
            {
                "version": "${{ steps.extract_version.outputs.version }}",
                "deployment": "enterprise"
            }
      - name: Trigger dispatch event - Multitenant
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
        # release please run 2 times, first for creating the PR and second for creating the release
        if: ${{ steps.release.outputs.releases_created == 'true' }}
        with:
          token: ${{ steps.app-dispatch-token.outputs.token }}
          repository: rudderlabs/rudderstack-operator
          event-type: release-rudder-server
          client-payload: |
            {
                "version": "${{ steps.extract_version.outputs.version }}",
                "deployment": "multitenant"
            }
      - name: Trigger dispatch event - hosted
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
        # release please run 2 times, first for creating the PR and second for creating the release
        if: ${{ steps.release.outputs.releases_created == 'true' }}
        with:
          token: ${{ steps.app-dispatch-token.outputs.token }}
          repository: rudderlabs/rudder-devops
          event-type: release-server-hosted
          client-payload: |
            {
                "version": "${{ steps.extract_version.outputs.version }}"
            }
