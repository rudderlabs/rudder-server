name: Docker Build (ECR)
on:
  workflow_call:
    inputs:
      image_names:
        description: 'JSON array of Docker image names (e.g., ["rudderstack/rudder-server", "rudderlabs/another-image"])'
        required: true
        type: string
      tags:
        description: 'Docker tags configuration'
        required: true
        type: string
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      aws_ecr_iam_role_arn:
        description: 'AWS ECR IAM Role ARN'
        required: true
        type: string
      aws_ecr_region:
        description: 'AWS ECR Region'
        required: true
        type: string

permissions:
  id-token: write # allows the JWT to be requested from GitHub's OIDC provider
  contents: read  # This is required for actions/checkout

env:
  arch_amd64: amd64
  arch_arm64: arm64

jobs:
  docker-meta:
    runs-on: ubuntu-latest
    outputs:
      labels: ${{ steps.meta.outputs.labels }}
      build-date: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
      version: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
      revision: ${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}
      tags: ${{ steps.meta.outputs.tags }}
      arm64_tags: ${{ steps.arm64_meta.outputs.tags }}
      arm64_labels: ${{ steps.arm64_meta.outputs.labels }}
      amd64_tags: ${{ steps.amd64_meta.outputs.tags }}
      amd64_labels: ${{ steps.amd64_meta.outputs.labels }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@a03048d87541d1d9fcf2ecf528a4a65ba9bd7838 # v5.0.0
        with:
          role-to-assume: ${{ inputs.aws_ecr_iam_role_arn }}
          aws-region: ${{ inputs.aws_ecr_region }}
          role-session-name: ${{ github.event.repository.name }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1

      - name: Process image names
        id: process-images
        run: |          # Convert JSON array to multiline format with "name=" prefix
          FORMATTED_IMAGES=$(echo '${{ inputs.image_names }}' | jq -r '.[] | "name=${{ steps.login-ecr.outputs.registry }}/\(.)"')
          echo "formatted_images<<EOF" >> $GITHUB_OUTPUT
          echo "$FORMATTED_IMAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0
        with:
          images: |
            ${{ steps.process-images.outputs.formatted_images }}
          tags: |
            type=ref,event=branch
            type=raw,value=${{ github.head_ref }},enable=${{ github.event_name == 'pull_request' }}
            type=raw,value=latest,enable=${{ github.event_name == 'release' }}
            type=semver,pattern={{version}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}
            type=semver,pattern={{major}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}

      - name: Docker arm64 meta
        id: arm64_meta
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0
        with:
          images: |
            ${{ steps.process-images.outputs.formatted_images }}
          tags: |
            type=ref,event=branch
            type=raw,value=${{ github.head_ref }},enable=${{ github.event_name == 'pull_request' }}
            type=raw,value=latest,enable=${{ github.event_name == 'release' }}
            type=semver,pattern={{version}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}
            type=semver,pattern={{major}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}
          flavor: |
            suffix=-${{ env.arch_arm64 }},onlatest=true

      - name: Docker amd64 meta
        id: amd64_meta
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0
        with:
          images: |
            ${{ steps.process-images.outputs.formatted_images }}
          tags: |
            type=ref,event=branch
            type=raw,value=${{ github.head_ref }},enable=${{ github.event_name == 'pull_request' }}
            type=raw,value=latest,enable=${{ github.event_name == 'release' }}
            type=semver,pattern={{version}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}
            type=semver,pattern={{major}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ github.ref == format('refs/heads/{0}', 'main') || github.event_name == 'release' }}
          flavor: |
            suffix=-${{ env.arch_amd64 }},onlatest=true

  docker-build:
    needs: docker-meta
    strategy:
      matrix:
        build-config:
          - os: [ self-hosted, Linux, ARM64, ubuntu-22 ]
            tags: ${{ needs.docker-meta.outputs.arm64_tags }}
            labels: ${{ needs.docker-meta.outputs.arm64_labels }}
            platform: linux/arm64
          - os: ubuntu-latest
            tags: ${{ needs.docker-meta.outputs.amd64_tags }}
            labels: ${{ needs.docker-meta.outputs.amd64_labels }}
            platform: linux/amd64
    runs-on: ${{ matrix.build-config.os }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@a03048d87541d1d9fcf2ecf528a4a65ba9bd7838 # v5.0.0
        with:
          role-to-assume: ${{ inputs.aws_ecr_iam_role_arn }}
          aws-region: ${{ inputs.aws_ecr_region }}
          role-session-name: ${{ github.event.repository.name }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build, scan and push
        uses: rudderlabs/build-scan-push-action@96d7bfca912dd2e8805dbb322dc2540504ecac1e # v2.1.0
        with:
          context: .
          file: ./${{ inputs.dockerfile }}
          platforms: ${{ matrix.build-config.platform }}
          push: true
          tags: ${{ matrix.build-config.tags }}
          labels: ${{ matrix.build-config.labels }}
          build-args: |
            BUILD_DATE=${{ needs.docker-meta.outputs.build-date }}
            VERSION=${{ needs.docker-meta.outputs.version }}
            COMMIT_HASH=${{ github.sha }}
            REVISION=${{ needs.docker-meta.outputs.revision }}

  create-manifest:
    runs-on: ubuntu-latest
    needs: [ docker-build, docker-meta ]
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@a03048d87541d1d9fcf2ecf528a4a65ba9bd7838 # v5.0.0
        with:
          role-to-assume: ${{ inputs.aws_ecr_iam_role_arn }}
          aws-region: ${{ inputs.aws_ecr_region }}
          role-session-name: ${{ github.event.repository.name }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1

      - name: Create multi-arch manifest for Docker
        run: |
          while read -r tag; do
            echo "$tag"
            arm_tag=$(echo "${{ needs.docker-meta.outputs.arm64_tags }}" | grep "$tag")
            echo "$arm_tag"
            amd_tag=$(echo "${{ needs.docker-meta.outputs.amd64_tags }}" | grep "$tag")
            echo "$amd_tag"
            docker buildx imagetools create -t $tag $arm_tag $amd_tag
          done <<< "${{ needs.docker-meta.outputs.tags }}"

