name: Dispatch deploy event

on: workflow_dispatch

permissions:
  contents: read # Required for basic repository access

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Generate GitHub App Token for Cross-Repo Dispatch
        id: app-dispatch-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write
          repositories: rudder-devops

      - name: Repository dispatch
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3.0.0
        with:
          token: ${{ steps.app-dispatch-token.outputs.token }}
          repository: rudderlabs/rudder-devops
          event-type: deploy-event
          client-payload: |
            {
              "repo": "${{ github.repository }}",
              "commit-sha": "${{ github.sha }}",
              "images": {
                "server": {
                  "tag": "${{ github.ref_name }}"
                },
                "gateway": {
                  "tag": "${{ github.ref_name }}"
                },
                "warehouse-master": {
                  "tag": "${{ github.ref_name }}"
                },
                "warehouse-slave": {
                  "tag": "${{ github.ref_name }}"
                }
              },
              "value-paths": []
            }
